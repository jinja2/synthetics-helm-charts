suite: Test ConfigMap
templates:
  - templates/configmap-ca.yaml
  - templates/deployment.yaml
values:
  - ./values/configmap-ca_tests.yaml
tests:
  - it: should create a ConfigMap with the correct name
    templates:
      - templates/configmap-ca.yaml
    asserts:
      - isKind:
          of: ConfigMap
      - matchRegex:
          path: metadata.name
          pattern: ".*splunk-synthetics-runner$"
  - it: should have the correct data keys and values
    templates:
      - templates/configmap-ca.yaml
    asserts:
      - equal:
          path: data["customer.test.com.cert"]
          value: |
            -----BEGIN CERTIFICATE-----
            MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA7
            -----END CERTIFICATE-----
      - equal:
          path: data["another.test.com.cert"]
          value: |-
            -----BEGIN CERTIFICATE-----
            MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA8
            -----END CERTIFICATE-----
  - it: should add correct volumeMounts to deployment
    templates:
      - templates/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.containers[0].volumeMounts
          value:
            - name: another-test-com-cert
              mountPath: /usr/local/share/ca-certificates/another.test.com.cert
              subPath: another.test.com.cert
              readOnly: false
            - name: customer-test-com-cert
              mountPath: /usr/local/share/ca-certificates/customer.test.com.cert
              subPath: customer.test.com.cert
              readOnly: false
  - it: should add correct volumes to deployment
    templates:
      - templates/deployment.yaml
    asserts:
      - equal:
          path: spec.template.spec.volumes
          value:
            - name: another-test-com-cert
              configMap:
                name: RELEASE-NAME-splunk-synthetics-runner
                items:
                  - key: another.test.com.cert
                    path: another.test.com.cert
            - name: customer-test-com-cert
              configMap:
                name: RELEASE-NAME-splunk-synthetics-runner
                items:
                  - key: customer.test.com.cert
                    path: customer.test.com.cert
  - it: should add cmd/args to pod spec
    templates:
      - templates/deployment.yaml
    asserts:
      - exists:
        path: spec.template.spec.containers[0].args
      - exists:
        path: spec.template.spec.containers[0].command
